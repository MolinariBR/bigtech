# Projeto Bigtech — Modelos de Dados (Entities)

---
precedence: 4
version: 1.3.0
depends_on: [1.Project.md,2.Architecture.md,3.Structure.md]
influences: [5.Pages.md,6.UserStories.md,7.Tasks.md,8.DesignSystem.md]
last_update: 2025-12-26
---

## Índice dos Documentos

* [1.Project.md](1.Project.md) - Visão geral do projeto
* [2.Architecture.md](2.Architecture.md) - Arquitetura técnica
* [3.Structure.md](3.Structure.md) - Estrutura do projeto
* [4.Entities.md](4.Entities.md) - Modelos de dados (entidades)
* [5.Pages.md](5.Pages.md) - Páginas e interfaces
* [6.UserStories.md](6.UserStories.md) - User Stories
* [7.Tasks.md](7.Tasks.md) - Tasks de implementação
* [8.DesignSystem.md](8.DesignSystem.md) - Design System

---

## 1. Descrição

Este documento define os modelos de dados (entidades) do Projeto Bigtech.
As entidades representam os objetos de negócio centrais, suas propriedades, relacionamentos e regras de integridade.

O sistema opera em **infraestrutura única compartilhada (single-tenant)**, com **isolamento lógico multi-tenant** realizado por meio de identificadores, regras de acesso, escopos de dados e validações no CORE.

As entidades são implementadas em **TypeScript**, persistidas no **Appwrite (BaaS)** e acessadas pelo **CORE** e pelos **plugins**, mantendo um modelo **agnóstico, extensível e escalável**.

---

## 2. Princípios de Modelagem

* **Isolamento Lógico Multi-Tenant**:
  As entidades utilizam identificadores de contexto (`tenantId`, `userId`, `organizationId`) para segmentação lógica de dados, sem segregação por banco, container ou instância.

* **Extensibilidade**:
  Entidades CORE são mínimas; plugins adicionam campos e comportamentos via composição ou contratos bem definidos.

* **Persistência**:
  O Appwrite gerencia collections e documents sobre MariaDB/PostgreSQL.

* **Validação**:
  Regras de negócio são aplicadas no CORE; plugins validam apenas extensões sob sua responsabilidade.

* **Relacionamentos**:
  Definidos via referências (IDs), evitando joins complexos e facilitando agregações.

---

## 3. Entidades Principais

### 3.1 User

Representa usuários finais ou administrativos.

```ts
interface User {
  id: string;
  type: 'empresa' | 'usuario_final';
  identifier: string;
  name: string;
  email?: string;
  phone?: string;           // Telefone do usuário (opcional)
  role: 'viewer' | 'editor' | 'admin';
  status: 'active' | 'inactive';
  credits: number;
  allowedPlugins: string[]; // Plugins que o usuário pode acessar
  preferences?: string;     // JSON string com preferências do usuário (tema, idioma, notificações, avatar)
  createdAt: Date;
  updatedAt: Date;
}
```

* **Regras**: Autenticação via CPF/CNPJ; unicidade de `identifier` global. Acesso a plugins de consulta controlado via `allowedPlugins` (subset dos plugins disponíveis no sistema). Campo `preferences` armazena configurações como JSON string.

---

### 3.3 Plugin

Representa módulos funcionais carregados dinamicamente pelo sistema.

```ts
interface Plugin {
  id: string;
  tenantId: string;
  type: 'consulta' | 'pagamento' | 'mercado' | 'funcional';
  name: string;
  version: string;
  status: 'installed' | 'enabled' | 'disabled';
  config: PluginConfig;
  dependencies?: string[];
  createdAt: Date;
  updatedAt: Date;
}

interface PluginConfig {
  costPerQuery?: number;
  apiKey?: string;
  fallbackSources?: string[];
}
```

* **Regras**: Gerenciado pelo `pluginLoader`, com contratos padronizados.
* **Auditoria**: Alterações geram eventos (`plugin_enabled`, `plugin_disabled`, etc.).
* **Relacionamentos**: N:1 com Tenant; 1:N com Consulta.

---

### 3.2 Consulta

Representa solicitações de dados executadas por usuários.

```ts
interface Consulta {
  id: string;
  userId: string;
  pluginId: string;
  type: 'credito' | 'cadastral' | 'veicular' | 'imobiliario';
  input: ConsultaInput;
  output: ConsultaOutput;
  status: 'pending' | 'success' | 'failed';
  cost: number;
  executedAt: Date;
  createdAt: Date;
}
```

* **Regras**: Executada via plugins; custo debitado automaticamente.
* **Relacionamentos**: N:1 com User e Plugin; 1:1 com Billing.

---

### 3.3 Billing

Representa transações financeiras e controle de créditos.

```ts
interface Billing {
  id: string;
  userId: string;
  type: 'credit_purchase' | 'query_debit' | 'refund';
  amount: number;
  currency: 'BRL';
  pluginId?: string;
  consultaId?: string;
  creditAmount?: number;
  creditValue?: number;
  paymentMethod?: string;
  externalTransactionId?: string;
  metadata?: Record<string, any>;
  status: 'pending' | 'completed' | 'failed';
  processedAt: Date;
  createdAt: Date;
}
```

* **Regras**: Processado pelo `billingEngine`.
* **Compliance**: Política de retenção mínima de 7 anos.
* **Relacionamentos**: N:1 com User; 1:1 opcional com Consulta.

---

### 3.4 Audit

Registra ações relevantes para compliance e rastreabilidade.

```ts
interface Audit {
  id: string;
  userId?: string;
  action: string;
  resource: string;
  details: any;
  ipAddress: string;
  timestamp: Date;
}
```

* **Regras**: Gerado automaticamente; imutável.
* **Relacionamentos**: Opcional com User.

---

### 3.7 SystemSettings

Representa configurações globais do sistema, aplicáveis a todos os tenants.

```ts
interface SystemSettings {
  id: string; // Sempre único, ex.: "global"
  billing: SystemBillingSettings;
  email: SystemEmailSettings;
  smtp: SystemSmtpSettings;
  rates: SystemRatesSettings;
  updatedAt: Date;
  updatedBy: string; // userId do admin que alterou
}

interface SystemBillingSettings {
  minCreditPurchase: number;
  maxCreditPurchase: number;
  creditValue: number; // Valor em BRL por crédito
  retentionDays: number; // Dias de retenção de transações
}

interface SystemEmailSettings {
  fromEmail: string;
  replyToEmail: string;
  supportEmail: string;
}

interface SystemSmtpSettings {
  host: string;
  port: number;
  secure: boolean;
  user: string;
  pass: string; // Criptografado
}

interface SystemRatesSettings {
  defaultRateLimit: number; // Consultas por hora por tenant
  fallbackCostMultiplier: number; // Multiplicador para consultas fallback
}
```

* **Regras**: Acesso restrito a admins globais; mudanças auditadas.
* **Relacionamentos**: Nenhum direto; influencia Tenant.settings e Plugin.config.

---

Os relacionamentos permanecem **idênticos**, com isolamento **exclusivamente lógico**, sempre filtrado por `tenantId`.

*(diagramas mantidos sem alteração estrutural)*

---

## 5. Regras de Integridade e Validação

* **Unicidade**:
  `User.identifier` único global.

* **Isolamento**:
  Dados são acessados com base no tipo de usuário e permissões.

* **Versionamento**:
  `createdAt` e `updatedAt` obrigatórios para auditoria.

* **Extensibilidade**:
  Plugins podem definir sub-entidades sem quebrar o CORE.

---

## 6. Persistência e Acesso

* **Collections Appwrite**: Uma collection por entidade.
* **Acesso**: CORE controla permissões; plugins operam via contexto validado.
* **Migrações**: Scripts versionados para evolução de schema.

---

## 7. Evolução de Entidades

* **MVP**: User, Plugin, Consulta, Billing, Audit.
* **Expansão**: Novos campos e tipos por plugin.
* **Plugins**: Podem introduzir entidades próprias.

---

## 8. Referências

* Appwrite Data Modeling
* TypeScript Interfaces

---

## 9. Histórico de Versões

* **Versão 1.4.0** (27/12/2025): Remoção do conceito de tenant; usuários classificados diretamente como 'empresa' ou 'usuario_final'; isolamento baseado em tipo de usuário.
* **Versão 1.3.0** (26/12/2025): Adição dos campos `phone` e `preferences` à entidade User para suporte completo ao perfil de usuário editável.
* **Versão 1.2.0** (24/12/2025): Adição da entidade SystemSettings para configurações globais (billing, email, SMTP, rates), alinhada com necessidades de administração do sistema.
* **Versão 1.1.0** (24/12/2025): Alinhamento completo com tenancy lógico definido em 1.Project.md, 2.Architecture.md e 3.Structure.md.
* **Versão 1.0** (20/12/2025): Criação inicial do documento 4.Entities.md.
