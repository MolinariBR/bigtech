# Projeto Bigtech — Modelos de Dados (Entities)

## Índice dos Documentos

- [1.Project.md](1.Project.md) - Visão geral do projeto
- [2.Architecture.md](2.Architecture.md) - Arquitetura técnica
- [3.Structure.md](3.Structure.md) - Estrutura do projeto
- [4.Entities.md](4.Entities.md) - Modelos de dados (entidades)
- [5.Pages.md](5.Pages.md) - Páginas e interfaces
- [6.UserStories.md](6.UserStories.md) - User Stories
- [7.Tasks.md](7.Tasks.md) - Tasks de implementação
- [8.DesignSystem.md](8.DesignSystem.md) - Design System

## 1. Descrição

Este documento define os modelos de dados (entidades) do Projeto Bigtech, baseado na arquitetura SaaS multi-tenant orientada a plugins. As entidades representam os objetos de negócio centrais, suas propriedades, relacionamentos e regras de integridade. Elas são implementadas em TypeScript, armazenadas no Appwrite (BaaS) com isolamento por tenant, e acessadas via CORE e plugins.

O foco é em entidades transversais (CORE) e extensíveis (plugins), garantindo agnosticismo e escalabilidade. Entidades são versionadas e documentadas para evolução controlada.

## 2. Princípios de Modelagem

- **Isolamento Multi-Tenant**: Cada entidade inclui `tenantId` para isolamento lógico em bancos Appwrite separados.
- **Extensibilidade**: Entidades CORE são mínimas; plugins adicionam campos específicos via herança ou composição.
- **Persistência**: Appwrite gerencia bancos MariaDB/PostgreSQL; entidades mapeadas para collections/documents.
- **Validação**: Regras de negócio aplicadas no CORE; plugins validam extensões.
- **Relacionamentos**: Definidos via referências (IDs) para evitar joins complexos em multi-tenant.

## 3. Entidades Principais

### 3.1 Tenant
Representa um cliente da plataforma, com isolamento completo.

```typescript
interface Tenant {
  id: string; // UUID gerado pelo Appwrite
  name: string; // Nome do tenant (ex.: "Empresa XYZ")
  domain?: string; // Domínio customizado (opcional)
  status: 'active' | 'inactive' | 'suspended'; // Status do tenant
  createdAt: Date; // Data de criação
  updatedAt: Date; // Última atualização
  plugins: string[]; // IDs dos plugins ativos (referência a Plugin)
  settings: TenantSettings; // Configurações específicas
}

interface TenantSettings {
  fallbackEnabled: boolean; // Habilita fallback de fontes
  rateLimit: number; // Limite de consultas por hora
  theme: 'light' | 'dark'; // Tema padrão
}
```

- **Regras**: Criado via frontend-admin; isolamento via container Docker; unicidade de Tenant.name globalmente.
- **Relacionamentos**: 1:N com User, 1:N com Consulta, 1:N com Billing.

### 3.2 User
Representa usuários finais ou administradores dentro de um tenant.

```typescript
interface User {
  id: string; // UUID Appwrite
  tenantId: string; // Referência ao Tenant
  type: 'user' | 'admin'; // Tipo de usuário
  identifier: string; // CPF ou CNPJ (único por tenant)
  name: string; // Nome completo
  email?: string; // Email opcional
  role: 'viewer' | 'editor' | 'admin'; // Permissões
  status: 'active' | 'inactive'; // Status
  credits: number; // Créditos disponíveis
  createdAt: Date;
  updatedAt: Date;
}
```

- **Regras**: Autenticação via CPF/CNPJ; isolamento por tenantId.
- **Relacionamentos**: N:1 com Tenant, 1:N com Consulta, 1:N com Billing.

### 3.3 Plugin
Representa um módulo extensível instalado na plataforma.

```typescript
interface Plugin {
  id: string; // UUID
  tenantId: string; // Tenant proprietário (ou global se compartilhado)
  type: 'consulta' | 'pagamento' | 'mercado' | 'funcional'; // Tipo
  name: string; // Nome (ex.: "infosimples")
  version: string; // Versão semântica (ex.: "1.0.0")
  status: 'installed' | 'enabled' | 'disabled'; // Estado
  config: PluginConfig; // Configurações específicas
  dependencies?: string[]; // IDs ou nomes de plugins dos quais este plugin depende
  createdAt: Date;
  updatedAt: Date;
}

interface PluginConfig {
  costPerQuery?: number; // Custo por consulta (para plugins de consulta)
  apiKey?: string; // Chave API para integrações externas
  fallbackSources?: string[]; // Fontes de fallback (IDs de outros plugins)
  // Observação: `PluginConfig` deve ter um schema validável (JSON Schema ou similar)
  // para permitir validação automática no `pluginLoader` e exibição de erros amigáveis na UI.
}
```

- **Regras**: Gerenciado pelo pluginLoader; contratos padronizados.
 - **Regras**: Gerenciado pelo pluginLoader; contratos padronizados.
 - **Eventos/Auditoria**: Todas as alterações de plugins (instalação, habilitação, desabilitação, configuração, remoção) devem gerar eventos de auditoria com `action` padronizado: `plugin_installed`, `plugin_enabled`, `plugin_disabled`, `plugin_configured`, `plugin_removed`.
- **Relacionamentos**: N:1 com Tenant, 1:N com Consulta (via execução).

### 3.4 Consulta
Representa uma solicitação e resultado de consulta de dados.

```typescript
interface Consulta {
  id: string; // UUID
  tenantId: string; // Tenant
  userId: string; // Usuário solicitante
  pluginId: string; // Plugin usado (ex.: consulta/infosimples)
  type: 'credito' | 'cadastral' | 'veicular' | 'imobiliario'; // Categoria de consulta (alinhada com páginas)
  input: ConsultaInput; // Dados de entrada
  output: ConsultaOutput; // Resultado normalizado
  status: 'pending' | 'success' | 'failed'; // Status
  cost: number; // Custo debitado
  executedAt: Date; // Data de execução
  createdAt: Date;
}

interface ConsultaInput {
  cnpj?: string; // Para categoria crédito
  cpf?: string; // Para categoria cadastral
  placa?: string; // Para categoria veicular
  endereco?: string; // Para categoria imobiliario
}

interface ConsultaOutput {
  data: any; // Dados normalizados (JSON)
  source: string; // Fonte usada (ex.: "Infosimples")
  error?: string; // Mensagem de erro, se aplicável
}
```

- **Regras**: Executada via plugins; billing automático.
- **Relacionamentos**: N:1 com Tenant, N:1 com User, N:1 com Plugin, 1:1 com Billing (transação associada).

### 3.5 Billing
Representa transações de cobrança e créditos.

```typescript
interface Billing {
  id: string; // UUID
  tenantId: string; // Tenant
  userId: string; // Usuário
  type: 'credit_purchase' | 'query_debit' | 'refund'; // Tipo
  amount: number; // Valor (positivo para crédito, negativo para débito)
  currency: 'BRL'; // Moeda
  pluginId?: string; // Plugin de pagamento usado
  consultaId?: string; // Consulta associada (se débito)
  creditAmount?: number; // Quantidade de créditos comprados (para credit_purchase)
  creditValue?: number; // Valor unitário do crédito (para credit_purchase)
  paymentMethod?: string; // Método de pagamento (ex.: 'asaas', 'pix')
  externalTransactionId?: string; // ID da transação no gateway
  status: 'pending' | 'completed' | 'failed'; // Status
  processedAt: Date; // Data de processamento
  createdAt: Date;
}
```

- **Regras**: Processado pelo billingEngine; integra com plugins de pagamento.
 - **Regras**: Processado pelo billingEngine; integra com plugins de pagamento.
 - **Relatórios e Retenção**: Cada registro `Billing` deve conter metadados suficientes para exportação e auditoria. Adicionar `metadata?: Record<string, any>` quando necessário para detalhes de gateway. Definir política de retenção (ex.: 7 anos) conforme compliance e registrar alterações via `Audit`.
 - **Agregações**: O sistema deve permitir agregações eficientes (sum, avg, count) por tenant e por período (dia/semana/mês) para dashboards e relatórios financeiros.
- **Relacionamentos**: N:1 com Tenant, N:1 com User, 1:1 com Consulta (opcional).

### 3.6 Audit
Representa logs de auditoria para compliance e rastreamento.

```typescript
interface Audit {
  id: string; // UUID
  tenantId: string; // Tenant
  userId?: string; // Usuário (opcional)
  action: string; // Ação (ex.: "consulta_executada", "plugin_enabled")
  resource: string; // Recurso afetado (ex.: "consulta:123")
  details: any; // Detalhes adicionais (JSON)
  ipAddress: string; // IP do solicitante
  timestamp: Date; // Data/hora
}
```

- **Regras**: Gerado automaticamente pelo CORE; armazenado permanentemente.
- **Relacionamentos**: N:1 com Tenant, N:1 com User (opcional).

## 4. Relacionamentos e Diagramas

### 4.1 Relacionamentos
- **Tenant** (1) -- (N) **User**: Um tenant tem múltiplos usuários.
- **Tenant** (1) -- (N) **Plugin**: Um tenant instala múltiplos plugins.
- **Tenant** (1) -- (N) **Consulta**: Consultas isoladas por tenant.
- **Tenant** (1) -- (N) **Billing**: Transações por tenant.
- **User** (1) -- (N) **Consulta**: Usuário executa consultas.
- **User** (1) -- (N) **Billing**: Usuário tem histórico de billing.
- **Plugin** (1) -- (N) **Consulta**: Plugin executa consultas.
- **Consulta** (1) -- (1) **Billing**: Cada consulta gera uma transação.
- **Tenant/User** (1) -- (N) **Audit**: Logs por tenant/usuário.

### 4.2 Diagrama Entidades (Texto)
```
[Tenant]
├── id, name, status, plugins[]
├── [User] (N)
│   ├── id, tenantId, identifier, credits
│   ├── [Consulta] (N)
│   │   ├── id, userId, pluginId, output
│   │   └── [Billing] (1)
│   │       └── id, consultaId, amount
│   └── [Billing] (N)
├── [Plugin] (N)
│   ├── id, tenantId, type, config
│   └── [Consulta] (N)  // Via execução
└── [Audit] (N)
    └── id, tenantId, action, timestamp
```

### 4.5 Agregação de Dados por Tenant
Para dashboards administrativos e relatórios globais, os dados são agregados por tenant para métricas como:
- Contagem de tenants ativos (Tenant.status = 'active').
- Consumo total por tenant (soma de Billing.amount onde status = 'completed').
- Número de usuários por tenant (contagem de User por tenantId).
- Consultas executadas por tenant (contagem de Consulta por tenantId).
- Agregações temporais (por dia/semana/mês) para gráficos de uso.
- Validação: Dados agregados devem refletir isolamento multi-tenant, sem vazamento entre tenants.

### 4.6 Auditoria de Ações
Para compliance e rastreamento de ações, a entidade Audit é usada para logs detalhados:
- Ações auditadas: Execução de consultas, ativação/desativação de plugins, compras de créditos, alterações em tenants.
- Campos críticos: action (tipo de ação), resource (recurso afetado), details (dados adicionais), ipAddress (para rastreamento).
- Agregações: Contagem de ações por tenant/usuário, filtros por período/tipo.
- Validação: Logs imutáveis, armazenados permanentemente para auditoria externa.

### 4.7 Normalização de Dados de Consulta
Para garantir consistência nos dados retornados pelas consultas, a entidade Consulta utiliza normalização:
- Campos padronizados: input (dados de entrada validados), output (dados estruturados em JSON).
- Validação: Dados de fontes externas são mapeados para schema comum (ex.: endereco → address).
- Regras: Fallback automático se fonte primária falhar, sem alteração de dados originais.
- Agregações: Contagem de consultas por tipo/status para métricas.
- Testes Property-Based: Validam que dados de diferentes fontes (ex.: Infosimples) são normalizados consistentemente para o mesmo schema, independente de variações na API externa.

### 4.8 Processamento de Pagamentos
Para integrações com gateways de pagamento, a entidade Billing suporta processamento seguro:
- Campos: paymentMethod, externalTransactionId, status (pending/completed/failed).
- Validação: Transações únicas, rollback em caso de falha.
- Regras: Créditos adicionados apenas após confirmação, notificações automáticas.
- Agregações: Soma de valores por período/tenant para relatórios financeiros.

## 5. Regras de Integridade e Validação

- **Unicidade**: `User.identifier` único por tenant; `Plugin.name` único por tenant.
- **Referências**: IDs devem existir (validado no CORE).
- **Isolamento**: Queries filtram por `tenantId`.
- **Versionamento**: Entidades incluem `createdAt`/`updatedAt` para auditoria.
- **Extensibilidade**: Plugins podem definir sub-entidades (ex.: `ConsultaImobiliario` estendendo `Consulta`).

## 6. Persistência e Acesso

- **Appwrite Collections**: Cada entidade mapeada para uma collection (ex.: `tenants`, `users`).
- **Acesso**: CORE via SDK Appwrite; plugins acessam via contexto.
- **Migrações**: Scripts para evoluir schemas (ex.: adicionar campos em `PluginConfig`).

## 7. Evolução de Entidades

- **MVP**: Entidades básicas (Tenant, User, Plugin, Consulta, Billing, Audit).
- **Expansão**: Adicionar campos para novos tipos de consulta/pagamento.
- **Plugins**: Podem introduzir entidades próprias (ex.: `WebhookConfig` em plugin webhooks).

## 8. Referências

- Appwrite Data Modeling: https://appwrite.io/docs/databases
- TypeScript Interfaces: https://www.typescriptlang.org/docs/handbook/interfaces.html

## 9. Histórico de Versões

- **Versão 1.6** (22 de dezembro de 2025): Atualização das regras da entidade Tenant para incluir unicidade global de Tenant.name, alinhando com US-009 e 5.Pages.md.
- **Versão 1.5** (22 de dezembro de 2025): Adição das seções 4.7 (Normalização de Dados de Consulta) e 4.8 (Processamento de Pagamentos) para suporte a validações de plugins de consulta e pagamento.
- **Versão 1.4** (22 de dezembro de 2025): Adição da seção 4.6 sobre auditoria de ações para suporte a compliance e rastreamento detalhado.
- **Versão 1.3** (22 de dezembro de 2025): Adição da seção 4.5 sobre agregação de dados por tenant para suportar dashboards administrativos e métricas globais.
- **Versão 1.2** (21 de dezembro de 2025): Refatoração da entidade Billing para suportar compra de créditos pré-pagos, adicionando campos creditAmount, creditValue, paymentMethod e externalTransactionId.
- **Versão 1.1** (20 de dezembro de 2025): Refatoração baseada em 5.Pages.md v1.1. Atualização de Consulta.type para categorias (credito, cadastral, veicular, imobiliario) e comentários em ConsultaInput para alinhamento com páginas.
- **Versão 1.0** (20 de dezembro de 2025): Criação inicial do documento 4.Entities.md baseado em 1.Project.md, 2.Architecture.md e 3.Structure.md. Definição de entidades com foco em isolamento multi-tenant e extensibilidade.
- **Versão 1.7** (20 de dezembro de 2025): Atualização da seção 4.7 para incluir testes property-based para validação de normalização consistente em plugins como Infosimples.