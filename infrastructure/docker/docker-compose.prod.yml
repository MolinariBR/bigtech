# Baseado em: 3.Structure.md v1.1, 2.Architecture.md v1.0.1
# Precedência: 1.Project → 2.Architecture → 3.Structure
# Decisão: Docker Compose para produção com isolamento multi-tenant

version: '3.8'

services:
  # Appwrite (Backend as a Service)
  appwrite:
    image: appwrite/appwrite:1.8.0
    container_name: appwrite
    restart: unless-stopped
    networks:
      - bigtech-network
    environment:
      - APPWRITE_ENV=production
      - APPWRITE_URL=https://api.bigtech.com.br
      - APPWRITE_HTTP_PORT=80
      - APPWRITE_HTTPS_PORT=443
      - APPWRITE_UI_URL=https://admin.bigtech.com.br
      - APPWRITE_DOMAIN=bigtech.com.br
      - APPWRITE_CONSOLE_WHITELIST_ROOT=disabled
      - APPWRITE_CONSOLE_WHITELIST_EMAILS=
      - APPWRITE_CONSOLE_WHITELIST_IPS=
      - APPWRITE_DB_HOST=mariadb
      - APPWRITE_DB_PORT=3306
      - APPWRITE_DB_SCHEMA=appwrite
      - APPWRITE_DB_USER=appwrite
      - APPWRITE_DB_PASS=${APPWRITE_DB_PASS}
      - APPWRITE_REDIS_HOST=redis
      - APPWRITE_REDIS_PORT=6379
      - APPWRITE_REDIS_PASS=${REDIS_PASS}
      - APPWRITE_STORAGE_DEVICE=local
      - APPWRITE_STORAGE_LIMIT=30000000
      - APPWRITE_USAGE_STATS=disabled
      - APPWRITE_SMTP_HOST=${SMTP_HOST}
      - APPWRITE_SMTP_PORT=${SMTP_PORT}
      - APPWRITE_SMTP_SECURE=${SMTP_SECURE}
      - APPWRITE_SMTP_USERNAME=${SMTP_USERNAME}
      - APPWRITE_SMTP_PASSWORD=${SMTP_PASSWORD}
    volumes:
      - appwrite-uploads:/storage/uploads:rw
      - appwrite-cache:/storage/cache:rw
      - appwrite-config:/storage/config:rw
      - appwrite-certificates:/storage/certificates:rw
      - appwrite-functions:/storage/functions:rw
    depends_on:
      - mariadb
      - redis
    ports:
      - "80:80"
      - "443:443"

  # MariaDB Database
  mariadb:
    image: mariadb:10.7
    container_name: mariadb
    restart: unless-stopped
    networks:
      - bigtech-network
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_DATABASE=appwrite
      - MYSQL_USER=appwrite
      - MYSQL_PASSWORD=${APPWRITE_DB_PASS}
    volumes:
      - mariadb-data:/var/lib/mysql:rw
    ports:
      - "3306:3306"
    command: --innodb-flush-method=fsync

  # Redis Cache
  redis:
    image: redis:7.0-alpine
    container_name: redis
    restart: unless-stopped
    networks:
      - bigtech-network
    environment:
      - REDIS_PASSWORD=${REDIS_PASS}
    volumes:
      - redis-data:/data:rw
    ports:
      - "6379:6379"

  # Frontend User (app.bigtech.com.br)
  frontend-user:
    build:
      context: ../../frontend-app
      dockerfile: Dockerfile
    container_name: frontend-user
    restart: unless-stopped
    networks:
      - bigtech-network
    environment:
      - NEXT_PUBLIC_APPWRITE_ENDPOINT=http://appwrite:80
      - NEXT_PUBLIC_APPWRITE_PROJECT=bigtech
    depends_on:
      - appwrite
    ports:
      - "3000:3000"

  # Frontend Admin (admin.bigtech.com.br)
  frontend-admin:
    build:
      context: ../../frontend-admin
      dockerfile: Dockerfile
    container_name: frontend-admin
    restart: unless-stopped
    networks:
      - bigtech-network
    environment:
      - NEXT_PUBLIC_APPWRITE_ENDPOINT=http://appwrite:80
      - NEXT_PUBLIC_APPWRITE_PROJECT=bigtech
    depends_on:
      - appwrite
    ports:
      - "3001:3001"

  # Backend Core (Multi-tenant containers)
  backend-core-tenant1:
    build:
      context: ../../backend
      dockerfile: Dockerfile
    container_name: backend-core-tenant1
    restart: unless-stopped
    networks:
      - bigtech-network
    environment:
      - APPWRITE_ENDPOINT=http://appwrite:80
      - APPWRITE_PROJECT_ID=bigtech
      - APPWRITE_API_KEY=${APPWRITE_API_KEY}
      - NODE_ENV=production
      - TENANT_ID=tenant1
      - ACTIVE_PLUGINS=consulta-infosimples,pagamento-asaas
    depends_on:
      - appwrite
    ports:
      - "4001:4000"

  backend-core-tenant2:
    build:
      context: ../../backend
      dockerfile: Dockerfile
    container_name: backend-core-tenant2
    restart: unless-stopped
    networks:
      - bigtech-network
    environment:
      - APPWRITE_ENDPOINT=http://appwrite:80
      - APPWRITE_PROJECT_ID=bigtech
      - APPWRITE_API_KEY=${APPWRITE_API_KEY}
      - NODE_ENV=production
      - TENANT_ID=tenant2
      - ACTIVE_PLUGINS=consulta-serasa,pagamento-pagarme
    depends_on:
      - appwrite
    ports:
      - "4002:4000"

  # Nginx Reverse Proxy
  nginx:
    image: nginx:alpine
    container_name: nginx-proxy
    restart: unless-stopped
    networks:
      - bigtech-network
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - nginx-ssl:/etc/nginx/ssl:ro
    depends_on:
      - frontend-user
      - frontend-admin
      - backend-core-tenant1
      - backend-core-tenant2

volumes:
  mariadb-data:
  redis-data:
  appwrite-uploads:
  appwrite-cache:
  appwrite-config:
  appwrite-certificates:
  appwrite-functions:
  nginx-ssl:

networks:
  bigtech-network:
    driver: bridge